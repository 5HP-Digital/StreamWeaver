{% extends 'base.html' %}

{% block extra_head %}
<style>
    .card {
        margin-bottom: 20px;
    }
    .source-card {
        height: 100%;
    }
    .action-buttons {
        display: flex;
        gap: 5px;
    }
    .modal-backdrop {
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block content %}
<div id="app">
    <!-- Settings Section -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h2 class="h4 mb-0">Settings</h2>
            <div v-if="settingsStatus !== 'idle'" class="d-flex align-items-center">
                <small class="text-muted me-2" v-if="settingsStatus === 'modified'">Modified</small>
                <small class="text-muted me-2" v-if="settingsStatus === 'saving'">Saving...</small>
                <small class="text-success me-2" v-if="settingsStatus === 'saved'">Saved</small>
                <div v-if="settingsStatus === 'saving'" class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Saving...</span>
                </div>
                <i v-if="settingsStatus === 'saved'" class="bi bi-check-circle-fill text-success"></i>
            </div>
        </div>
        <div class="card-body">
            <div class="alert alert-danger" v-if="settingsError">
                [[ settingsError ]]
            </div>

            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="syncEnabled" v-model="settings.sync_enabled" @change="onSettingsChange">
                <label class="form-check-label" for="syncEnabled">Sync Enabled</label>
            </div>

            <div class="mb-3">
                <label class="form-label">Sync Schedule</label>
                <div class="mb-2 form-check">
                    <input type="checkbox" class="form-check-input" id="dailySync" v-model="settings.sync_schedule.daily" @change="onSettingsChange">
                    <label class="form-check-label" for="dailySync">Run daily sync</label>
                </div>

                <div v-if="!settings.sync_schedule.daily" class="mb-3">
                    <label class="form-label">Schedule by day of week</label>
                    <div v-for="(day, index) in daysOfWeek" :key="day" class="mb-2">
                        <div class="d-flex align-items-center">
                            <label class="form-label me-3 mb-0" style="width: 100px;">[[ day ]]</label>
                            <div class="d-flex flex-wrap">
                                <div v-for="(time, timeIndex) in getDayTimes(day.toLowerCase())" :key="timeIndex" class="me-2 mb-2">
                                    <div class="input-group input-group-sm" style="width: 150px;">
                                        <input type="time" class="form-control" v-model="settings.sync_schedule.times[day.toLowerCase()][timeIndex]" @change="onSettingsChange">
                                        <button class="btn btn-outline-danger" type="button" @click="removeTime(day.toLowerCase(), timeIndex)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-outline-primary mb-2" @click="addTime(day.toLowerCase())">
                                    <i class="bi bi-plus"></i> Add Time
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="allowChannelAutoDeletion" v-model="settings.allow_channel_auto_deletion" @change="onSettingsChange">
                <label class="form-check-label" for="allowChannelAutoDeletion">Allow Channel Auto-Deletion</label>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">Service Providers</h1>
        <button class="btn btn-primary" @click="showAddModal">
            <i class="bi bi-plus"></i> Add New Provider
        </button>
    </div>

    <div class="alert alert-info" v-if="loading">
        <div class="spinner-border spinner-border-sm" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        Loading providers...
    </div>

    <div class="alert alert-danger" v-if="error">
        [[ error ]]
    </div>

    <div class="row" v-if="!loading && !error">
        <div v-if="sources.length === 0" class="col-12">
            <div class="alert alert-warning">
                No providers found. Click "Add New Provider" to create one.
            </div>
        </div>
        <div v-for="source in sources" :key="source.id" class="col-md-4 mb-4">
            <div class="card source-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="card-title mb-0">[[ source.name ]]</h5>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" :id="'toggle-' + source.id"
                                v-model="source.is_enabled" @change="toggleSourceEnabled(source)">
                            <label class="form-check-label" :for="'toggle-' + source.id">
                                [[ source.is_enabled ? 'Enabled' : 'Disabled' ]]
                            </label>
                        </div>
                    </div>
                    <p class="card-text">
                        <strong>URL:</strong> <a :href="source.url" target="_blank">[[ source.url ]]</a>
                    </p>
                    <p class="card-text">
                        <small class="text-muted">
                            Created: [[ formatDate(source.created_at) ]]<br>
                            Updated: [[ formatDate(source.updated_at) ]]
                        </small>
                    </p>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-primary" @click="showEditModal(source)">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-danger" @click="confirmDelete(source)">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Source Modal -->
    <div class="modal fade" id="sourceModal" tabindex="-1" aria-labelledby="sourceModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="sourceModalLabel">[[ editMode ? 'Edit' : 'Add' ]] Provider</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger" v-if="formError">
                        [[ formError ]]
                    </div>
                    <form @submit.prevent="saveSource">
                        <div class="mb-3">
                            <label for="sourceName" class="form-label">Name</label>
                            <input type="text" class="form-control" id="sourceName" v-model="currentSource.name" required maxlength="100">
                            <div class="form-text">Required, maximum 100 characters</div>
                        </div>
                        <div class="mb-3">
                            <label for="sourceUrl" class="form-label">URL</label>
                            <input type="url" class="form-control" id="sourceUrl" v-model="currentSource.url" required maxlength="500">
                            <div class="form-text">Required, must be a valid URL, maximum 500 characters</div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary" :disabled="formSubmitting">
                                <span v-if="formSubmitting" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                Save
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete the provider "[[ currentSource.name ]]"?</p>
                    <p class="text-danger">This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" @click="deleteSource" :disabled="formSubmitting">
                        <span v-if="formSubmitting" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Create Vue app
    const app = new Vue({
        el: '#app',
        delimiters: ['[[', ']]'],
        data: {
            sources: [],
            loading: true,
            error: null,
            currentSource: {
                id: null,
                name: '',
                url: ''
            },
            editMode: false,
            formError: null,
            formSubmitting: false,
            sourceModal: null,
            deleteModal: null,
            // Settings data
            settings: {
                sync_enabled: false,
                sync_schedule: {
                    daily: false,
                    times: {}
                },
                allow_channel_auto_deletion: true
            },
            settingsStatus: 'idle', // idle, modified, saving, saved
            settingsError: null,
            settingsTimeout: null,
            daysOfWeek: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday']
        },
        mounted() {
            this.fetchSources();
            this.fetchSettings();
            this.sourceModal = new bootstrap.Modal(document.getElementById('sourceModal'));
            this.deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        },
        methods: {
            fetchSources() {
                this.loading = true;
                this.error = null;

                axios.get('/api/sources/')
                    .then(response => {
                        this.sources = response.data;
                        this.loading = false;
                    })
                    .catch(error => {
                        console.error('Error fetching sources:', error);
                        this.error = 'Failed to load playlist sources. Please try again later.';
                        this.loading = false;
                    });
            },
            showAddModal() {
                this.editMode = false;
                this.currentSource = {
                    id: null,
                    name: '',
                    url: ''
                };
                this.formError = null;
                this.sourceModal.show();
            },
            showEditModal(source) {
                this.editMode = true;
                this.currentSource = {
                    id: source.id,
                    name: source.name,
                    url: source.url
                };
                this.formError = null;
                this.sourceModal.show();
            },
            saveSource() {
                this.formSubmitting = true;
                this.formError = null;

                const payload = {
                    name: this.currentSource.name,
                    url: this.currentSource.url
                }

                const request = this.editMode
                    ? axios.patch(`/api/sources/${this.currentSource.id}/`, payload)
                    : axios.post('/api/sources/', payload);

                request
                    .then(() => {
                        this.sourceModal.hide();
                        this.fetchSources();
                        this.formSubmitting = false;
                    })
                    .catch(error => {
                        console.error('Error saving service provider:', error);
                        this.formError = 'Failed to save service provider. Please check your input and try again.';
                        this.formSubmitting = false;
                    });
            },

            toggleSourceEnabled(source) {
                axios.patch(`/api/sources/${source.id}/`, {
                    is_enabled: source.is_enabled
                })
                .then(() => {
                    console.log(`Service provider ${source.id} ${source.is_enabled ? 'enabled' : 'disabled'}`);
                    // Refresh the sources to update the "Updated" timestamp
                    this.fetchSources();
                })
                .catch(error => {
                    console.error('Error toggling service provider enabled state:', error);
                    // Revert the toggle if there was an error
                    source.is_enabled = !source.is_enabled;
                    this.$forceUpdate();
                    alert('Failed to update service provider status. Please try again.');
                });
            },
            confirmDelete(source) {
                this.currentSource = {
                    id: source.id,
                    name: source.name,
                    url: source.url
                };
                this.deleteModal.show();
            },
            deleteSource() {
                this.formSubmitting = true;

                axios.delete(`/api/sources/${this.currentSource.id}/`)
                    .then(() => {
                        this.deleteModal.hide();
                        this.fetchSources();
                        this.formSubmitting = false;
                    })
                    .catch(error => {
                        console.error('Error deleting source:', error);
                        this.formSubmitting = false;
                        // Show error in delete modal
                        document.querySelector('#deleteModal .modal-body').innerHTML += 
                            `<div class="alert alert-danger mt-3">Failed to delete playlist source. Please try again later.</div>`;
                    });
            },
            formatDate(dateString) {
                if (!dateString) return 'N/A';
                const date = new Date(dateString);
                return date.toLocaleString();
            },

            // Settings methods
            fetchSettings() {
                axios.get('/api/settings/')
                    .then(response => {
                        this.settings = response.data;
                        // Initialize empty arrays for days that don't have times
                        this.daysOfWeek.forEach(day => {
                            if (!this.settings.sync_schedule.times[day.toLowerCase()]) {
                                this.$set(this.settings.sync_schedule.times, day.toLowerCase(), []);
                            }
                        });
                        this.settingsError = null;
                    })
                    .catch(error => {
                        console.error('Error fetching settings:', error);
                        this.settingsError = 'Failed to load settings. Please refresh the page.';
                    });
            },

            saveSettings() {
                this.settingsStatus = 'saving';

                axios.put('/api/settings/', this.settings)
                    .then(response => {
                        this.settings = response.data;
                        this.settingsStatus = 'saved';
                        this.settingsError = null;

                        // Reset status after 3 seconds
                        setTimeout(() => {
                            if (this.settingsStatus === 'saved') {
                                this.settingsStatus = 'idle';
                            }
                        }, 3000);
                    })
                    .catch(error => {
                        console.error('Error saving settings:', error);
                        this.settingsError = 'Failed to save settings. Please try again.';
                        this.settingsStatus = 'idle';
                    });
            },

            onSettingsChange() {
                this.settingsStatus = 'modified';

                // Clear existing timeout
                if (this.settingsTimeout) {
                    clearTimeout(this.settingsTimeout);
                }

                // Set new timeout to save after 3 seconds of inactivity
                this.settingsTimeout = setTimeout(() => {
                    this.saveSettings();
                }, 3000);
            },

            getDayTimes(day) {
                if (!this.settings.sync_schedule.times[day]) {
                    this.$set(this.settings.sync_schedule.times, day, []);
                }
                return this.settings.sync_schedule.times[day];
            },

            addTime(day) {
                if (!this.settings.sync_schedule.times[day]) {
                    this.$set(this.settings.sync_schedule.times, day, []);
                }
                this.settings.sync_schedule.times[day].push('12:00');
                this.onSettingsChange();
            },

            removeTime(day, index) {
                this.settings.sync_schedule.times[day].splice(index, 1);
                this.onSettingsChange();
            }
        }
    });
</script>
{% endblock %}
